# Logstash Configuration për Smart Grid Analytics
# Përpunon logs nga të gjitha shërbimet dhe i dërgon në Elasticsearch

input {
  # Beats input për logs nga aplikacionet
  beats {
    port => 5044
  }
  
  # TCP input për logs direkte
  tcp {
    port => 5000
    codec => json
  }
  
  # File input për logs lokale (nëse ka)
  file {
    path => "/var/log/smartgrid/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{/ {
    json {
      source => "message"
    }
  }
  
  # Parse log format standard
  grok {
    match => { 
      "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:log_message}"
    }
  }
  
  # Parse service name nga log message
  if [fields][service] {
    mutate {
      add_field => { "service" => "%{[fields][service]}" }
    }
  }
  
  # Parse log level
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }
  
  # Add timestamp nëse mungon
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # Parse error messages
  if [level] == "ERROR" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  # Parse warnings
  if [level] == "WARNING" {
    mutate {
      add_tag => [ "warning" ]
    }
  }
  
  # GeoIP për IP addresses (nëse ka)
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # GeoIP për ip_address field (për threat detection)
  if [ip_address] {
    geoip {
      source => "ip_address"
      target => "geoip"
    }
  }
  
  # Include threat detection filters (SIEM - 100% SECURITY)
  # Threat detection rules janë në threat-detection.conf
}

output {
  # Output në Elasticsearch
  elasticsearch {
    hosts => ["smartgrid-elasticsearch:9200"]
    index => "smartgrid-logs-%{+YYYY.MM.dd}"
    template_name => "smartgrid-logs"
    template => "/usr/share/logstash/templates/smartgrid-logs-template.json"
    template_overwrite => true
  }
  
  # Debug output (vetëm për development)
  if "_grokparsefailure" in [tags] {
    stdout {
      codec => rubydebug
    }
  }
}

