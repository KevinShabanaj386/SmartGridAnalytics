# SIEM Threat Detection Rules për Logstash
# Detekton security threats dhe anomalies në logs

filter {
  # ============================================
  # 1. Failed Login Attempts Detection
  # ============================================
  if [event_type] == "login_failed" or [message] =~ /(?i)(failed|invalid|unauthorized).*login/i {
    mutate {
      add_tag => [ "security_threat", "failed_login" ]
      add_field => { "threat_type" => "authentication_failure" }
      add_field => { "threat_severity" => "medium" }
    }
    
    # Detekton brute force attacks (më shumë se 5 failed attempts në 5 minuta)
    if [ip_address] {
      aggregate {
        task_id => "%{ip_address}"
        code => "
          map['failed_count'] ||= 0
          map['failed_count'] += 1
          map['first_failure'] ||= event.get('@timestamp')
          map['last_failure'] = event.get('@timestamp')
        "
        push_previous_map_as_event => true
        timeout => 300  # 5 minuta
        timeout_tags => [ "brute_force_detected" ]
      }
    }
  }
  
  # ============================================
  # 2. SQL Injection Detection
  # ============================================
  if [message] =~ /(?i)(union.*select|drop.*table|insert.*into|delete.*from|exec.*\(|script.*>|javascript:|onerror=|onload=)/i {
    mutate {
      add_tag => [ "security_threat", "sql_injection" ]
      add_field => { "threat_type" => "injection_attack" }
      add_field => { "threat_severity" => "high" }
    }
  }
  
  # ============================================
  # 3. XSS (Cross-Site Scripting) Detection
  # ============================================
  if [message] =~ /(?i)(<script|javascript:|onerror=|onload=|eval\(|document\.cookie|alert\(|prompt\(|confirm\()/i {
    mutate {
      add_tag => [ "security_threat", "xss_attack" ]
      add_field => { "threat_type" => "xss_attack" }
      add_field => { "threat_severity" => "high" }
    }
  }
  
  # ============================================
  # 4. Unauthorized Access Detection
  # ============================================
  if [response_status] == 403 or [response_status] == 401 {
    mutate {
      add_tag => [ "security_threat", "unauthorized_access" ]
      add_field => { "threat_type" => "unauthorized_access" }
      add_field => { "threat_severity" => "medium" }
    }
  }
  
  # ============================================
  # 5. Rate Limiting Violations
  # ============================================
  if [message] =~ /(?i)(rate.*limit|too.*many.*requests|429)/i {
    mutate {
      add_tag => [ "security_threat", "rate_limit_violation" ]
      add_field => { "threat_type" => "abuse" }
      add_field => { "threat_severity" => "low" }
    }
  }
  
  # ============================================
  # 6. IP Lockout Detection
  # ============================================
  if [message] =~ /(?i)(ip.*locked|ip.*blocked|lockout)/i {
    mutate {
      add_tag => [ "security_threat", "ip_lockout" ]
      add_field => { "threat_type" => "abuse" }
      add_field => { "threat_severity" => "medium" }
    }
  }
  
  # ============================================
  # 7. High Risk User Detection (Behavioral Analytics)
  # ============================================
  if [risk_score] and [risk_score] > 70 {
    mutate {
      add_tag => [ "security_threat", "high_risk_user" ]
      add_field => { "threat_type" => "behavioral_anomaly" }
      add_field => { "threat_severity" => "high" }
    }
  }
  
  # ============================================
  # 8. Unusual Access Patterns
  # ============================================
  if [ip_address] and [user_id] {
    # Detekton access nga IP të re për user
    if [is_new_ip] == true {
      mutate {
        add_tag => [ "security_threat", "unusual_access" ]
        add_field => { "threat_type" => "access_anomaly" }
        add_field => { "threat_severity" => "medium" }
      }
    }
  }
  
  # ============================================
  # 9. Data Access Violations (DAG)
  # ============================================
  if [classification] and [classification] in ["CONFIDENTIAL", "RESTRICTED"] {
    if [action] == "read" or [action] == "write" {
      mutate {
        add_tag => [ "security_threat", "sensitive_data_access" ]
        add_field => { "threat_type" => "data_access" }
        add_field => { "threat_severity" => "medium" }
      }
    }
  }
  
  # ============================================
  # 10. Service Errors (Potential Attacks)
  # ============================================
  if [level] == "ERROR" and [message] =~ /(?i)(connection.*refused|timeout|denied|forbidden|unauthorized)/i {
    mutate {
      add_tag => [ "security_threat", "service_error" ]
      add_field => { "threat_type" => "service_anomaly" }
      add_field => { "threat_severity" => "low" }
    }
  }
  
  # ============================================
  # 11. JWT Token Violations
  # ============================================
  if [message] =~ /(?i)(invalid.*token|expired.*token|token.*verification.*failed|jwt.*error)/i {
    mutate {
      add_tag => [ "security_threat", "token_violation" ]
      add_field => { "threat_type" => "authentication_failure" }
      add_field => { "threat_severity" => "medium" }
    }
  }
  
  # ============================================
  # 12. OAuth2 Violations
  # ============================================
  if [message] =~ /(?i)(invalid.*client|unauthorized.*client|oauth.*error|client.*credentials.*failed)/i {
    mutate {
      add_tag => [ "security_threat", "oauth2_violation" ]
      add_field => { "threat_type" => "authentication_failure" }
      add_field => { "threat_severity" => "high" }
    }
  }
  
  # ============================================
  # 13. Kafka Consumer Lag (Potential DoS)
  # ============================================
  if [kafka_lag] and [kafka_lag] > 10000 {
    mutate {
      add_tag => [ "security_threat", "kafka_lag" ]
      add_field => { "threat_type" => "performance_anomaly" }
      add_field => { "threat_severity" => "low" }
    }
  }
  
  # ============================================
  # 14. Database Connection Failures
  # ============================================
  if [message] =~ /(?i)(database.*connection.*failed|postgres.*error|connection.*pool.*exhausted)/i {
    mutate {
      add_tag => [ "security_threat", "database_error" ]
      add_field => { "threat_type" => "infrastructure_anomaly" }
      add_field => { "threat_severity" => "medium" }
    }
  }
  
  # ============================================
  # 15. Geographic Anomalies (Unusual Locations)
  # ============================================
  if [geoip] and [geoip][country_code] {
    # Nëse IP është nga vend i panjohur ose i rrezikshëm
    if [geoip][country_code] in ["CN", "RU", "KP"] {
      mutate {
        add_tag => [ "security_threat", "geographic_anomaly" ]
        add_field => { "threat_type" => "geographic_risk" }
        add_field => { "threat_severity" => "low" }
      }
    }
  }
  
  # ============================================
  # Enrichment: Add threat metadata
  # ============================================
  if "security_threat" in [tags] {
    mutate {
      add_field => { 
        "threat_detected_at" => "%{@timestamp}"
        "threat_source" => "%{service}"
      }
    }
    
    # Add correlation ID për threat events
    if ![threat_correlation_id] {
      mutate {
        add_field => { "threat_correlation_id" => "%{[@metadata][threat_id]}" }
      }
    }
  }
}

# Output për threat events në index të veçantë
output {
  if "security_threat" in [tags] {
    elasticsearch {
      hosts => ["smartgrid-elasticsearch:9200"]
      index => "smartgrid-threats-%{+YYYY.MM.dd}"
      template_name => "smartgrid-threats"
      template_overwrite => true
    }
    
    # Alert nëse threat severity është high ose critical
    if [threat_severity] in ["high", "critical"] {
      # Në prodhim, këtu do të dërgohej alert në notification service
      # Për tani, vetëm loggojmë
    }
  }
}

