# Istio Retry Policies për të gjitha services
# Përcakton retry behavior për different scenarios

---
# Retry Policy për Critical Operations
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: retry-policy-critical
  namespace: smartgrid
spec:
  hosts:
  - "*"
  http:
  # High priority retries për critical operations
  - match:
    - uri:
        prefix: "/api/v1/ingest"
    - uri:
        prefix: "/api/v1/analytics/predictive"
    route:
    - destination:
        host: api-gateway
    retries:
      attempts: 5
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
    timeout: 60s

---
# Retry Policy për Standard Operations
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: retry-policy-standard
  namespace: smartgrid
spec:
  hosts:
  - "*"
  http:
  - match:
    - uri:
        prefix: "/api/v1/analytics"
    route:
    - destination:
        host: api-gateway
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: 5xx,reset
    timeout: 30s

---
# Retry Policy për Non-Critical Operations
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: retry-policy-non-critical
  namespace: smartgrid
spec:
  hosts:
  - "*"
  http:
  - match:
    - uri:
        prefix: "/api/v1/notifications"
    route:
    - destination:
        host: api-gateway
    retries:
      attempts: 2
      perTryTimeout: 3s
      retryOn: 5xx
    timeout: 15s

